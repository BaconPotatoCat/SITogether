name: Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh/
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H "$AWS_HOST" >> ~/.ssh/known_hosts
      env:
        SSH_PRIVATE_KEY: ${{ secrets.AWS_SSH_PRIVATE_KEY }}
        AWS_HOST: ${{ secrets.AWS_HOST }}

    - name: Deploy to AWS
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_SSH_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
          set -e  # Exit on any error
          
          # Navigate to project directory (adjust path as needed)
          cd /services/SITogether
          
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose down || true
          
          echo "ğŸ”¨ Building containers (no cache)..."
          if ! docker-compose build --no-cache; then
            echo "âŒ Docker Compose build failed!"
            echo "ğŸ“‹ Container logs:"
            docker-compose logs
            echo "ğŸ“Š Container status:"
            docker-compose ps -a
            exit 1
          fi

          echo "ğŸš€ Starting containers..."
          if ! docker-compose up -d; then
            echo "âŒ Docker Compose up failed!"
            echo "ğŸ“‹ Container logs:"
            docker-compose logs
            echo "ğŸ“Š Container status:"
            docker-compose ps -a
            exit 1
          fi
          
          echo "â³ Waiting for containers to initialize (30s)..."
          sleep 30
          
          echo "ğŸ“Š Checking container status..."
          docker-compose ps -a
          
          echo "ğŸ“‹ Backend initialization logs:"
          docker-compose logs backend | head -n 50
          
          echo "âœ… Build completed successfully"
          echo "ğŸ“Š Container status:"
          docker-compose ps
        EOF

    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.AWS_SSH_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
          set -e  # Exit on any error
          
          cd /services/SITogether
          
          echo "â³ Waiting for services to start..."
          sleep 30
          
          echo "ğŸ“Š Checking container health..."
          docker-compose ps
          
          # Check if any containers exited
          if docker-compose ps -q | xargs docker inspect -f '{{.Name}}: {{.State.Status}}' | grep -q "exited\|dead\|failed"; then
            echo "âŒ Some containers failed to start!"
            echo "ğŸ“‹ Detailed container status:"
            docker-compose ps -a
            echo "ğŸ“‹ Container logs:"
            docker-compose logs
            exit 1
          fi
          
          echo "ğŸ” Testing frontend accessibility..."
          if ! curl -f --max-time 10 http://localhost:3000 > /dev/null 2>&1; then
            echo "âš ï¸  Frontend not responding yet, but containers are running"
            echo "ğŸ“‹ Frontend container logs:"
            docker-compose logs frontend
          else
            echo "âœ… Frontend is accessible"
          fi
          
          echo "ğŸ” Testing backend health..."
          # Check backend health using wget inside the backend container
          if ! docker-compose exec -T backend wget -q -O- --timeout=10 http://127.0.0.1:5000/health > /dev/null 2>&1; then
            echo "âŒ Backend health check failed!"
            echo "ğŸ“‹ Backend container logs:"
            docker-compose logs backend
            exit 1
          else
            echo "âœ… Backend health check passed"
          fi
          
          echo "ğŸ‰ Deployment verification completed"
        EOF
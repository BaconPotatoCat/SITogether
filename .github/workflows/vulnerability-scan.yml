name: Vulnerability Scanning

on:
  push: # Run on all branches and commits
  pull_request: # Run on pull requests (for ZAP scans)
  workflow_dispatch: # Allow manual triggering

jobs:
  # Note: npm audit and ESLint security are already covered in ci.yml
  # This workflow focuses on additional security scanning tools

  # CodeQL static analysis
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # OWASP Dependency-Check (comprehensive vulnerability scanning)
  owasp-scan:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.directory }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.directory }}
        run: npm ci

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: '${{ matrix.directory }}'
          path: '${{ matrix.directory }}'
          format: 'HTML'
          args: >
            --scan ${{ matrix.directory }}
            --out reports
            --enableRetired
            --enableExperimental

      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-report-${{ matrix.directory }}
          path: reports
          retention-days: 30

  # OWASP ZAP Dynamic Application Security Testing (DAST)
  owasp-zap:
    name: OWASP ZAP Security Scan
    # Run on pull requests, manual dispatch, or pushes to non-main branches (likely PR branches)
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref != 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      issues: none
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@sitogether-db:5432/${DB_NAME:-sitogether_db}
          DB_NAME=${DB_NAME:-sitogether_db}
          DB_USER=${DB_USER:-postgres}
          DB_PASSWORD=${DB_PASSWORD:-postgres}
          JWT_SECRET=test-secret-key-for-zap-scanning
          NODE_ENV=test
          EOF
        env:
          DB_NAME: sitogether_db
          DB_USER: postgres
          DB_PASSWORD: postgres

      - name: Start services with Docker Compose
        run: |
          # Create temporary override to expose backend port 5000 for ZAP scanning
          cat > docker-compose.override.zap.yml << 'EOF'
          services:
            backend:
              ports:
                - "5000:5000"
          EOF
          # Start all services - docker compose handles health checks and dependencies automatically
          echo "ðŸš€ Starting containers..."
          if ! docker compose -f docker-compose.yml -f docker-compose.override.zap.yml up -d; then
            echo "âŒ Docker Compose up failed!"
            echo "ðŸ“‹ Container logs:"
            docker compose -f docker-compose.yml -f docker-compose.override.zap.yml logs
            echo "ðŸ“Š Container status:"
            docker compose -f docker-compose.yml -f docker-compose.override.zap.yml ps -a
            exit 1
          fi
          
          echo "â³ Waiting for containers to initialize (30s)..."
          sleep 30
          
          echo "ðŸ“Š Checking container status..."
          docker compose -f docker-compose.yml -f docker-compose.override.zap.yml ps -a
          
          echo "ðŸ“‹ Backend initialization logs:"
          docker compose -f docker-compose.yml -f docker-compose.override.zap.yml logs backend | head -n 50

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be healthy..."
          # Verify services are responding
          timeout 120 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:5000/health > /dev/null 2>&1 || curl -f http://localhost:5000 > /dev/null 2>&1; do sleep 2; done'
          echo "âœ“ Services are ready!"

      - name: Seed test user for ZAP authentication
        run: |
          echo "Creating encrypted test user for ZAP authenticated scanning..."
          sleep 5

          docker exec sitogether-backend node - << 'EOF'
          const { PrismaClient } = require('@prisma/client');
          const bcrypt = require('bcrypt');
          const { prepareEmailForStorage, encryptField } = require('../utils/fieldEncryption');

          const prisma = new PrismaClient();

          (async () => {
            try {
              const email = 'zap-test@example.com';
              const password = await bcrypt.hash('zap-test-password-123', 10);

              // Prepare and encrypt fields
              const { emailHash, encryptedEmail } = await prepareEmailForStorage(email);

              const encryptedAge = await encryptField(20, (v) => v.toString());
              const encryptedGender = await encryptField('Other');
              const encryptedCourse = await encryptField(null);
              const encryptedBio = await encryptField(null);
              const encryptedInterests = await encryptField([], () => null);

              const user = await prisma.user.upsert({
                where: { emailHash },
                update: { verified: true },
                create: {
                  email: encryptedEmail,
                  emailHash,
                  password,
                  name: 'ZAP Test User',
                  age: encryptedAge,
                  gender: encryptedGender,
                  course: encryptedCourse,
                  bio: encryptedBio,
                  interests: encryptedInterests,
                  avatarUrl: null,
                  verified: true
                }
              });

              // Make sure user has a points entry
              await prisma.userPoints.upsert({
                where: { userId: user.id },
                update: {},
                create: { userId: user.id, totalPoints: 0 },
              });

              console.log('âœ“ ZAP test user created:', email);
              await prisma.$disconnect();
              process.exit(0);
            } catch (err) {
              console.error('âŒ Error creating ZAP test user:', err);
              await prisma.$disconnect();
              process.exit(1);
            }
          })();
          EOF

          echo "âœ“ Test user created successfully"

      - name: Create ZAP authentication context
        run: |
          mkdir -p .zap
          # Use the frontend test-login endpoint that bypasses 2FA
          # This ensures cookies are set for the frontend domain
          cat > .zap/auth.json << 'EOF'
          {
            "type": "form",
            "loginUrl": "http://localhost:3000/api/auth/test-login",
            "loginRequestData": "email=zap-test@example.com&password=zap-test-password-123",
            "loggedInRegex": "\"success\":\\s*true"
          }
          EOF
          echo "âœ“ ZAP authentication context created"
      
      - name: Prepare ZAP workspace
        run: |
          # Create report files with proper permissions
          touch zap.yaml report_json.json report_md.md report_html.html 2>/dev/null || true
          chmod 666 zap.yaml report_json.json report_md.md report_html.html 2>/dev/null || true
          chmod -R a+w . 2>/dev/null || true

      - name: Run OWASP ZAP Baseline Scan - Frontend (Unauthenticated)
        id: zap_baseline_frontend
        uses: zaproxy/action-baseline@v0.15.0
        continue-on-error: true
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false
          allow_issue_writing: false

      - name: Upload Baseline Frontend Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-frontend
          path: |
            report_json.json
            report_html.html
            report_md.md
          retention-days: 30
          if-no-files-found: warn

      - name: Run OWASP ZAP Baseline Scan - Backend API (Unauthenticated)
        id: zap_baseline_backend
        uses: zaproxy/action-baseline@v0.15.0
        continue-on-error: true
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false
          allow_issue_writing: false

      - name: Upload Baseline Backend Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-backend
          path: |
            report_json.json
            report_html.html
            report_md.md
          retention-days: 30
          if-no-files-found: warn

      - name: Run OWASP ZAP Full Scan - Frontend (Authenticated)
        id: zap_full_frontend
        uses: zaproxy/action-full-scan@v0.13.0
        continue-on-error: true
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J -c .zap/auth.json'
          fail_action: false
          allow_issue_writing: false

      - name: Upload Full Frontend Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-frontend
          path: |
            report_json.json
            report_html.html
            report_md.md
          retention-days: 30
          if-no-files-found: warn

      - name: Run OWASP ZAP Full Scan - Backend API (Authenticated)
        id: zap_full_backend
        uses: zaproxy/action-full-scan@v0.13.0
        continue-on-error: true
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J -c .zap/auth.json'
          fail_action: false
          allow_issue_writing: false

      - name: Upload Full Backend Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-backend
          path: |
            report_json.json
            report_html.html
            report_md.md
          retention-days: 30
          if-no-files-found: warn

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.zap.yml down -v || true
          rm -f docker-compose.override.zap.yml || true

  # Security summary
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, owasp-scan, owasp-zap]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** npm audit and ESLint security are already covered in ci.yml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Dependency-Check | ${{ needs.owasp-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP ZAP | ${{ needs.owasp-zap.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security scans completed. Review results above." >> $GITHUB_STEP_SUMMARY

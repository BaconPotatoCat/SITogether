name: Vulnerability Scanning

on:
  push: # Run on all branches and commits
  workflow_dispatch: # Allow manual triggering

jobs:
  # Note: npm audit and ESLint security are already covered in ci.yml
  # This workflow focuses on additional security scanning tools
  
  # CodeQL static analysis
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
      
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # OWASP Dependency-Check (comprehensive vulnerability scanning)
  owasp-scan:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        directory: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.directory }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ matrix.directory }}
        run: npm ci
      
      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: '${{ matrix.directory }}'
          path: '${{ matrix.directory }}'
          format: 'HTML'
          args: >
            --scan ${{ matrix.directory }}
            --out reports
            --enableRetired
            --enableExperimental
      
      - name: Upload OWASP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-report-${{ matrix.directory }}
          path: reports
          retention-days: 30

  # OWASP ZAP Dynamic Application Security Testing (DAST)
  owasp-zap:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@sitogether-db:5432/${DB_NAME:-sitogether_db}
          DB_NAME=${DB_NAME:-sitogether_db}
          DB_USER=${DB_USER:-postgres}
          DB_PASSWORD=${DB_PASSWORD:-postgres}
          JWT_SECRET=test-secret-key-for-zap-scanning
          NODE_ENV=test
          EOF
        env:
          DB_NAME: sitogether_db
          DB_USER: postgres
          DB_PASSWORD: postgres
      
      - name: Start services with Docker Compose
        run: |
          # Create temporary override to expose backend port 5000 for ZAP scanning
          cat > docker-compose.override.zap.yml << 'EOF'
          services:
            backend:
              ports:
                - "5000:5000"
          EOF
          # Start all services - docker compose handles health checks and dependencies automatically
          docker compose -f docker-compose.yml -f docker-compose.override.zap.yml up -d
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          # Wait for frontend
          timeout 120 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done' || true
          # Wait for backend
          timeout 60 bash -c 'until curl -f http://localhost:5000/health > /dev/null 2>&1 || curl -f http://localhost:5000 > /dev/null 2>&1; do sleep 2; done' || true
          sleep 10  # Additional wait for full initialization
          echo "Services are ready!"
      
      - name: Seed test user for ZAP authentication
        run: |
          echo "Creating test user for ZAP authenticated scanning..."
          # Wait a bit more for database to be fully ready
          sleep 5
          # Create test user using inline Node.js command (same logic as create-zap-test-user.js)
          docker exec sitogether-backend node -e "
            const { PrismaClient } = require('@prisma/client');
            const bcrypt = require('bcrypt');
            const prisma = new PrismaClient();
            (async () => {
              try {
                const hashedPassword = await bcrypt.hash('zap-test-password-123', 10);
                const testUser = await prisma.user.upsert({
                  where: { email: 'zap-test@example.com' },
                  update: { verified: true },
                  create: {
                    email: 'zap-test@example.com',
                    password: hashedPassword,
                    name: 'ZAP Test User',
                    age: 20,
                    gender: 'Other',
                    role: 'User',
                    verified: true,
                    interests: [],
                  },
                });
                console.log('Test user created:', testUser.email);
                await prisma.\$disconnect();
                process.exit(0);
              } catch (e) {
                console.error('Error creating test user:', e);
                await prisma.\$disconnect();
                process.exit(1);
              }
            })();
          " || {
            echo "âŒ Failed to create test user"
            echo "Backend container logs:"
            docker logs sitogether-backend 2>&1 | tail -30
            exit 1
          }
          echo "âœ“ Test user created successfully"
      
      - name: Create ZAP authentication context
        run: |
          mkdir -p .zap
          # Use the frontend test-login endpoint that bypasses 2FA
          # This ensures cookies are set for the frontend domain
          cat > .zap/auth.json << 'EOF'
          {
            "type": "form",
            "loginUrl": "http://localhost:3000/api/auth/test-login",
            "loginRequestData": "email=zap-test@example.com&password=zap-test-password-123",
            "loggedInRegex": "\"success\":\\s*true"
          }
          EOF
          echo "ZAP authentication context created (using test-login endpoint)"
        continue-on-error: true
      
      - name: Run OWASP ZAP Baseline Scan - Frontend (Unauthenticated)
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false
      
      - name: Run OWASP ZAP Baseline Scan - Backend API (Unauthenticated)
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false
        continue-on-error: true
      
      - name: Run OWASP ZAP Full Scan - Frontend (Authenticated)
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J -c .zap/auth.json'
          fail_action: false
        continue-on-error: true
      
      - name: Run OWASP ZAP Full Scan - Backend API (Authenticated)
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -J -c .zap/auth.json'
          fail_action: false
        continue-on-error: true
      
      - name: Upload ZAP results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-results
          path: |
            zap_report.html
            zap_report.json
            zap_report.xml
          retention-days: 30
      
      - name: Upload ZAP results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: zap_report.json
          category: 'zap-scan'
        continue-on-error: true
      
      - name: Cleanup
        if: always()
        run: |
          docker compose down -v || true
          # Cleanup temporary override file
          rm -f docker-compose.override.zap.yml || true

  # Security summary
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, owasp-scan, owasp-zap]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** npm audit and ESLint security are already covered in ci.yml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Dependency-Check | ${{ needs.owasp-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP ZAP | ${{ needs.owasp-zap.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All security scans completed. Review results above." >> $GITHUB_STEP_SUMMARY

